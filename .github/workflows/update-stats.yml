
# name: Update GitHub Stats
# on:
#   schedule:
#     - cron: '0 0 * * *'
#   workflow_dispatch:
#   push:
#     branches: [ main, master ]

# jobs:
#   update-readme:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: write
#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v4
#       with:
#         fetch-depth: 0

#     - name: Generate Snake Game
#       uses: Platane/snk@v3
#       with:
#         github_user_name: ${{ github.repository_owner }}
#         outputs: |
#           dist/github-contribution-grid-snake.svg
#           dist/github-contribution-grid-snake-dark.svg?palette=github-dark

#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'

#     - name: Update README with fresh timestamps
#       run: |
#         # Generate new timestamp
#         TIMESTAMP=$(date +%s%3N)
#         echo "Using timestamp: $TIMESTAMP"
        
#         # Update all cache_bust parameters in README
#         sed -i "s/cache_bust=[0-9]\+/cache_bust=$TIMESTAMP/g" README.md
        
#         echo "‚úÖ Updated all GitHub stats URLs with fresh timestamp"

#     - name: Commit and push changes
#       uses: stefanzweifel/git-auto-commit-action@v5
#       with:
#         commit_message: 'üîÑ Auto-update GitHub stats [skip ci]'
#         commit_user_name: 'github-actions[bot]'
#         commit_user_email: 'github-actions[bot]@users.noreply.github.com'
#         skip_dirty_check: false
#         skip_fetch: false
#         skip_checkout: false

name: Update GitHub Stats
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0

    - name: Generate Snake Game
      uses: Platane/snk@v3
      with:
        github_user_name: ${{ github.repository_owner }}
        outputs: |
          dist/github-contribution-grid-snake.svg
          dist/github-contribution-grid-snake-dark.svg?palette=github-dark
        github_token: ${{ secrets.GH_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Force Clear Cache and Update Stats
      run: |
        cat > update_readme.js << 'EOF'
        const fs = require('fs');
        const https = require('https');
        
        // Generate multiple timestamps to break cache
        const timestamps = [
          Date.now(),
          Date.now() + 1000,
          Date.now() + 2000,
          Date.now() + 3000,
          Date.now() + 4000
        ];
        
        // Try multiple cache-busting requests first
        console.log('üîÑ Attempting to clear GitHub Stats API cache...');
        for (let i = 0; i < timestamps.length; i++) {
          const url = `https://github-readme-stats.vercel.app/api?username=Entue250&count_private=true&include_all_commits=true&cache_bust=${timestamps[i]}`;
          
          try {
            https.get(url, () => {});
            console.log(`Cache clear attempt ${i + 1} completed`);
          } catch (error) {
            console.log(`Cache clear attempt ${i + 1} failed:`, error.message);
          }
          
          // Wait between requests
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        // Read README
        let readme = fs.readFileSync('README.md', 'utf8');
        const mainTimestamp = timestamps[0];
        
        console.log('üìù Updating README with enhanced parameters...');
        
        // Enhanced GitHub Stats with multiple fallback approaches
        readme = readme.replace(
          /github-readme-stats\.vercel\.app\/api\?username=Entue250[^"]*"/g,
          `github-readme-stats.vercel.app/api?username=Entue250&count_private=true&include_all_commits=true&show_icons=true&theme=radical&hide_border=true&bg_color=161b22&title_color=f75c7e&text_color=c9d1d9&icon_color=58a6ff&ring_color=f75c7e&show_owner=true&cache_bust=${mainTimestamp}"`
        );
        
        // Alternative stats service as backup
        console.log('üìä Using alternative GitHub stats configurations...');
        
        // Top Languages (including HTML/CSS)
        readme = readme.replace(
          /github-readme-stats\.vercel\.app\/api\/top-langs\/\?username=Entue250[^"]*"/g,
          `github-readme-stats.vercel.app/api/top-langs/?username=Entue250&count_private=true&include_all_commits=true&layout=compact&theme=radical&hide_border=true&bg_color=161b22&title_color=f75c7e&text_color=c9d1d9&langs_count=10&cache_bust=${mainTimestamp}"`
        );
        
        // GitHub Trophies
        readme = readme.replace(
          /github-profile-trophy\.vercel\.app\/\?username=Entue250[^"]*"/g,
          `github-profile-trophy.vercel.app/?username=Entue250&theme=radical&no-frame=true&no-bg=false&margin-w=4&margin-h=15&column=7&row=2&title=Commit,Followers,Stars,Repositories,Issues,PullRequest,Reviews&cache_bust=${mainTimestamp}"`
        );
        
        // Streak Stats
        readme = readme.replace(
          /github-readme-streak-stats\.herokuapp\.com\/\?user=Entue250[^"]*"/g,
          `github-readme-streak-stats.herokuapp.com/?user=Entue250&theme=radical&hide_border=true&background=161b22&stroke=f75c7e&ring=f75c7e&fire=f75c7e&currStreakLabel=f75c7e&sideLabels=c9d1d9&currStreakNum=c9d1d9&sideNums=c9d1d9&dates=8b949e&cache_bust=${mainTimestamp}"`
        );
        
        // Activity Graph
        readme = readme.replace(
          /github-readme-activity-graph\.vercel\.app\/graph\?username=Entue250[^"]*"/g,
          `github-readme-activity-graph.vercel.app/graph?username=Entue250&theme=react-dark&bg_color=161b22&color=c9d1d9&line=f75c7e&point=58a6ff&area=true&hide_border=true&custom_title=GitHub%20Activity%20Graph&cache_bust=${mainTimestamp}"`
        );
        
        // Write updated README
        fs.writeFileSync('README.md', readme);
        console.log('‚úÖ README updated with enhanced private repo tracking');
        console.log('üïê Cache bust timestamp:', mainTimestamp);
        console.log('üìä Expected: All 303 commits should appear within 24-48 hours');
        EOF
        
        node update_readme.js
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

    - name: Verify Private Repository Access
      run: |
        # Test GitHub API access to verify token permissions
        echo "üîç Verifying private repository access..."
        curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
             -H "Accept: application/vnd.github.v3+json" \
             https://api.github.com/user/repos?type=all&per_page=5 | \
             jq -r '.[] | "\(.name): \(.private)"' || echo "Token verification failed"

    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: 'üîÑ Enhanced private repo stats update [skip ci]'
        commit_user_name: 'github-actions[bot]'
        commit_user_email: 'github-actions[bot]@users.noreply.github.com'
